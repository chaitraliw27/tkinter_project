import pandas as pd
import difflib
from openpyxl import Workbook
import os

# Sample DataFrames
data1 = {'node_name': ['BFN', 'Wholesale', 'Security'],
         'in_jira': [2, 2, 0],
         'in_prod': [2, 2, 2],
         'in_both': [2, 0, 0]}

data2 = {'node_name': ['BFN', 'Wholesale', 'Security'],
         'in_jira': [2, 2, 2],
         'in_prod': [2, 2, 0],
         'in_both': [2, 0, 0]}

df1 = pd.DataFrame(data1)
df2 = pd.DataFrame(data2)

# Function to compute differences and save as HTML file
def compute_and_save_html_diff(row_idx, base_path="html_reports"):
    from_list = df1.iloc[row_idx].astype(str).tolist()
    to_list = df2.iloc[row_idx].astype(str).tolist()
    html_diff = difflib.HtmlDiff().make_file(
        from_list,
        to_list,
        context=True,
        numlines=5
    )
    # Ensure the base path exists
    if not os.path.exists(base_path):
        os.makedirs(base_path)
    # Define the HTML file path
    html_file_path = os.path.join(base_path, f'diff_report_{row_idx}.html')
    # Save the HTML content to a file
    with open(html_file_path, 'w', encoding='utf-8') as f:
        f.write(html_diff)
    return html_file_path

# Create an Excel workbook
wb = Workbook()
ws = wb.active

# Add headers
headers = list(df1.columns)
headers.append('Link')
ws.append(headers)

# Add data rows with hyperlinks
for idx, row in df1.iterrows():
    # Add row data
    row_data = list(row)
    
    # Compute HTML differences and save to file
    html_file_path = compute_and_save_html_diff(idx)
    
    # Create the hyperlink (relative path for easier sharing)
    # Assuming the base path is the current directory
    relative_path = os.path.relpath(html_file_path, start=os.getcwd())
    link = f'file:///{os.path.abspath(relative_path)}'
    
    # Add row data to the Excel sheet
    for col_idx, value in enumerate(row_data, 1):
        ws.cell(row=idx+2, column=col_idx).value = value

    # Add hyperlink for viewing the differences
    link_cell = ws.cell(row=idx+2, column=len(headers))
    link_cell.hyperlink = link
    link_cell.value = 'View HTML Report'
    link_cell.style = "Hyperlink"

# Save the Excel file
wb.save('output.xlsx')
